name: ASafariM Build and Prepare Artifacts

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      DOTNET_VERSION: '9.0.x'

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ§° Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ğŸ“ Create test results directories
      run: |
        mkdir -p tests/backend
        mkdir -p tests/frontend

    - name: ğŸ§ª Run Backend Tests
      run: dotnet test ASafariM.Test/ASafariM.Test.csproj --logger "trx;LogFileName=tests/backend/backend_test_results.trx"
      
    - name: ğŸ“Š Verify Backend Test Results
      run: |
        if grep -q 'outcome="Failed"' tests/backend/backend_test_results.trx; then
          echo "âŒ Backend tests failed. Aborting deployment."
          exit 1
        else
          echo "âœ… All backend tests passed. Proceeding with build."
        fi

    - name: ğŸ”¨ Build Backend
      run: dotnet publish ASafariM.Api/ASafariM.Api.csproj --configuration Release --output backend-publish

    - name: ğŸ§¶ Setup Node & Yarn
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'

    - name: ğŸ“¦ Install Dependencies
      run: yarn install --immutable

    # Run tests for all frontend projects
    - name: ğŸ§ª Run All Frontend Tests
      run: yarn test --reporter=json --outputFile=tests/frontend/frontend_test_results.json
      
    # Alternative approach - run tests for each frontend project separately
    - name: ğŸ§ª Run UI Tests
      if: ${{ always() }}
      run: yarn test:frontend:ui --reporter=json --outputFile=tests/frontend/ui_test_results.json || true
      
    - name: ğŸ§ª Run Blog Tests
      if: ${{ always() }}
      run: yarn test:frontend:blog --reporter=json --outputFile=tests/frontend/blog_test_results.json || true
      
    - name: ğŸ§ª Run Bibliography Tests
      if: ${{ always() }}
      run: yarn test:frontend:bibliography --reporter=json --outputFile=tests/frontend/bibliography_test_results.json || true

    # Build all frontend projects
    - name: âš™ï¸ Build UI Frontend
      working-directory: ASafariM.Clients/asafarim-ui
      run: yarn build
      
    - name: âš™ï¸ Build Blog
      working-directory: ASafariM.Clients/asafarim-blog
      run: yarn build
      
    - name: âš™ï¸ Build Bibliography
      working-directory: ASafariM.Clients/asafarim-bibliography
      run: yarn build

    # Upload test results as artifacts
    - name: ğŸ“¤ Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: tests/
        retention-days: 30

    # Upload build artifacts for all projects
    - name: ğŸ“¤ Upload UI Frontend Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ui-frontend-dist
        path: ASafariM.Clients/asafarim-ui/dist
        
    - name: ğŸ“¤ Upload Blog Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: blog-dist
        path: ASafariM.Clients/asafarim-blog/build
        
    - name: ğŸ“¤ Upload Bibliography Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: bibliography-dist
        path: ASafariM.Clients/asafarim-bibliography/dist

    - name: ğŸ“¤ Upload Backend Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: backend-publish
        path: backend-publish
